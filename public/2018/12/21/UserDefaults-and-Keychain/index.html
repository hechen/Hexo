<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="UserDefaults and Keychain"><meta name="keywords" content="UserDefaults,Keychain"><meta name="author" content="Chen,undefined"><meta name="copyright" content="Chen"><title>UserDefaults and Keychain | Writing, Thinking and Coding.</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b8b088e1ebab51ca1f8e3c11ac0476a1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>var GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"}}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#UserDefaults"><span class="toc-number">1.</span> <span class="toc-text">UserDefaults</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UserDefaults-构成"><span class="toc-number">1.1.</span> <span class="toc-text">UserDefaults 构成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UserDefaults-目的"><span class="toc-number">1.2.</span> <span class="toc-text">UserDefaults 目的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关于-Extension-中-UserDefaults-的应用"><span class="toc-number">1.3.</span> <span class="toc-text">关于 Extension 中 UserDefaults 的应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keychain"><span class="toc-number">2.</span> <span class="toc-text">Keychain</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#同一个-App-内部共享"><span class="toc-number">2.1.</span> <span class="toc-text">同一个 App 内部共享</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不同-App-之间共享"><span class="toc-number">2.2.</span> <span class="toc-text">不同 App 之间共享</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考文档"><span class="toc-number">3.</span> <span class="toc-text">参考文档</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://en.gravatar.com/userimage/112198960/798360714fd6208c863662c667290d7d.jpg?size=200"></div><div class="author-info__name text-center">Chen</div><div class="author-info__description text-center">I do stuff.</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">38</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">47</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">14</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container" style="background-image:url(true)"><div id="page-header"><span class="pull-left"><a id="site-name" href="/">Writing, Thinking and Coding.</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">UserDefaults and Keychain</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-01-03</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/">iOS</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2018/12/21/UserDefaults-and-Keychain/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2018/12/21/UserDefaults-and-Keychain/"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">1,585</span><span class="post-meta__separator">|</span><span>Reading time: 6 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>Apple 提供了几种持久化方案，其中 UserDefaults 和 Keychain 是 App 开发过程中使用频率最高的方案，而且从以往和同事的探讨过程中发现对这两个概念中有一些细节还是理解不太透彻，因此本文会针对这二者展开讲一讲。</p><h2 id="UserDefaults"><a href="#UserDefaults" class="headerlink" title="UserDefaults"></a>UserDefaults</h2><p>首先，阅读完 Apple 关于 UserDefaults 一节的文档描述之后，我觉得有两个需要注意的点：</p><ol><li>UserDefaults 的构成</li><li>UserDefaults 的目的</li></ol><h3 id="UserDefaults-构成"><a href="#UserDefaults-构成" class="headerlink" title="UserDefaults 构成"></a>UserDefaults 构成</h3><p>我们可以看看具体 UserDefaults 存储的地方，如下图，我们在应用中写入 Demo 数据：</p><p><img src="https://i.imgur.com/wq9onOa.png" alt="Write Key-Value to UserDefaults"></p><p>打印 Library 路径，在 Finder 中打开路径:</p><p><img src="https://i.imgur.com/65ybYX6.png" alt="Library"></p><p>如下展示内容，可以看到在 Preferences 目录中存在某个文件，例如该 App Library 目录下存放的文件为 <code>app.chen.ios.PersistenceDemo.plist</code></p><p><img src="https://i.imgur.com/ChqnDJa.png" alt="Cache"><br><img src="https://i.imgur.com/cPvlFdR.png" alt="Preferences"></p><p>该 plist 内容如图所示，即为我们之前在 App 中写入的 Key-Value。</p><p><img src="https://i.imgur.com/shdXoZN.png" alt="plist"></p><p>所以这也证明了，我们针对 UserDefaults 的读写实质上是针对 plist 文件的读写。</p><p>iOS 系统会自动帮你做 <code>plist</code> 文件的读入以及 Cache，根据情况会把你在内存中所做的操作同步到 <code>plist</code> 文件（UserDefaults 同步到内存是同步的，同步到 Database 是异步的， iOS 8 开始，会有一个常驻进程 <code>cfprefsd</code> 来负责同步）。</p><p>所以你会看有iOS 面试题目会问题： 系统的 <code>UserDefaults</code> 的本质以及和 plist 文件的直接读写的区别？（这题目太 TM 偏了。。。）</p><blockquote><p>UserDefaults caches the information to avoid having to open the user’s defaults database each time you need a default value. When you set a default value, it’s changed synchronously within your process, and asynchronously to persistent storage and other processes.</p></blockquote><p>所以，实质上，你是可以直接针对 UserDefaults 的最终产物 plist 文件进行操作的，当然，这是有风险的，而且无法保障正常使用的。官方在文档中也提醒了开发者。</p><blockquote><p>Don’t try to access the preferences subsystem directly. Modifying preference property list files may result in loss of changes, delay of reflecting changes, and app crashes. To configure preferences, use the defaults command-line utility in macOS instead.</p></blockquote><p>那既然本质上 UserDefaults 是使用 plist 文件进行存储，那也要求了我们能存储的 Value 只能支持 <code>plist</code> 所支持的格式，例如 <code>String</code>，<code>Number</code>，<code>Array</code>，<code>Data</code>，<code>Date</code> 等，当然如果你要存储自定义的类，其需要遵守 <code>Codable</code> 协议（实质也是要归档为 <code>Data</code>）</p><p><img src="https://i.imgur.com/cxWHfvS.png" alt="plist"></p><h3 id="UserDefaults-目的"><a href="#UserDefaults-目的" class="headerlink" title="UserDefaults 目的"></a>UserDefaults 目的</h3><blockquote><p>The defaults system allows an app to customize its behavior to match a user’s preferences. For example, you can allow users to specify their preferred units of measurement or media playback speed. Apps store these preferences by assigning values to a set of parameters in a user’s defaults database.</p></blockquote><p>一般我们在 <code>UserDefaults</code> 存储的数据都是用户的某些配置项，不因为用户使用过程中出现意外而丢失，比如是否开启了日夜间模式了，是否开启了大图模式了等等。或者存储一些对安全方面不敏感的数据</p><p>不建议往 <code>UserDefaults</code> 里存储较大的数据，例如直接存储一张图片。而对于这种需要存储较大文件的需求，你可以将文件本身存储到本地，而 <code>UserDefaults</code> 里只存储该文件的路径。</p><p>毕竟在 App 启动之后，UserDefaults 会进行 IO ，读取本地 plist 文件，因此一定程度上，也会较少 App 启动之后 UserDefaults API 针对 <code>plist</code> 文件 IO 的时间，纯属个人揣测，没有经过实验验证。</p><h3 id="关于-Extension-中-UserDefaults-的应用"><a href="#关于-Extension-中-UserDefaults-的应用" class="headerlink" title="关于 Extension 中 UserDefaults 的应用"></a>关于 Extension 中 UserDefaults 的应用</h3><p>iOS 上 Extension 和 Host App 之间做数据共享也是通过 UserDefaults，开启 App Group 之后，这二者就可以修改同一份配置。具体 Extension 和 Host App 之间的内在关系可以先看下 Apple 文档。本质上如下所示，</p><p><img src="https://i.imgur.com/cZFlz6o.png" alt="app_extensions_container_restrictions"></p><p>Extension 和 Host App 之间通过 Shared Container 来做数据共享，该 SharedContainer 私有，因此不存在于单一 App 的沙盒内。应该是系统会单独开辟一块空间用以做共享数据的存储。</p><blockquote><p>After you enable app groups, an app extension and its containing app can both use the NSUserDefaults API to share access to user preferences. To enable this sharing, use the initWithSuiteName: method to instantiate a new NSUserDefaults object, passing in the identifier of the shared group.</p></blockquote><p>因为 UserDefaults 既然是暴露在本地能够访问的文件当中的，因此不要在 UserDefaults 里存储任何 Security-Sensitive 的数据。 如果要存储保密级别较高的数据，就要用到另外一种持久化方案 ── Keychain</p><h2 id="Keychain"><a href="#Keychain" class="headerlink" title="Keychain"></a>Keychain</h2><p>关于 Keychain，是 Apple 提供给开发者用来存储 Security-Sensitive 的数据了，比如登录密码，用户标识，加密数据等等。 官方示意图如下，其实中间 Keychain 的 API 还进行了 Decrypt 和 Encrypt 的动作。</p><p><img src="https://i.imgur.com/tvA4lV3.png" alt="Keychain services API"></p><p>Apple 提供的 Keychain API 大部分都是 C 语言写成，使用起来相对不便，因此基本上我们都会使用二次加工过的库，比如知乎用的就是 SMKeychain。</p><p>Keychain 中的数据完全交由系统保管并加密过( AES 128 in GCM (Galois/Counter Mode))的，因此能够保证安全性。</p><p>如果对加密这一块感兴趣，可以看下<a href="https://www.apple.com/business/site/docs/iOS_Security_Guide.pdf" target="_blank" rel="noopener">苹果的白皮书</a>中 Keychain data protection 这一节。</p><p>另外，Keychain 的数据并不存放在 App 的 Sanbox 中，即使删除了 App，资料依然保存在 keychain 中。如果重新安装了app，还可以从 keychain 获取数据。</p><h3 id="同一个-App-内部共享"><a href="#同一个-App-内部共享" class="headerlink" title="同一个 App 内部共享"></a>同一个 App 内部共享</h3><p>类似 UserDefaults ，Keychain 也支持 Extension 和 host app 之间的共享，需要在每个 Target 的 Capability 下开启 Keychain Sharing 功能，并且设置为同一个 Group。</p><h3 id="不同-App-之间共享"><a href="#不同-App-之间共享" class="headerlink" title="不同 App 之间共享"></a>不同 App 之间共享</h3><p>和 UserDefaults 不同的是，Keychain 的数据是可以跨 App 获取的，但是限于一个开发者的 App，也就是需要确保这些 App 所属的 Team ID 是相同的。</p><p>这个也是App 进行 SSO 登录的基础，比如知乎日报使用知乎主 App 登录也是基于此原理。</p><p><img src="https://i.imgur.com/0L2MA23.png" alt="shared items"></p><p>在需要进行 Keychain 共享的 App 内开启 Keychain Sharing 的能力，所属同一个 Team ID 下的 App 本身都可以读取该 Keychain 的内容，类似于 AppGroup，这里也会产生 Keychain Group。</p><blockquote><p>Allows this application to share passwords from its keychain with other applications made by your team.</p></blockquote><p><img src="https://i.imgur.com/DJsInJb.png" alt="Keychain Sharing"></p><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><ol><li><a href="https://developer.apple.com/documentation/foundation/userdefaults" target="_blank" rel="noopener">https://developer.apple.com/documentation/foundation/userdefaults</a></li><li><a href="https://www.reddit.com/r/jailbreak/comments/2qpqi9/ios_812_has_protection_against_plist_file_editing/" target="_blank" rel="noopener">https://www.reddit.com/r/jailbreak/comments/2qpqi9/ios_812_has_protection_against_plist_file_editing/</a></li><li><a href="http://iphonedevwiki.net/index.php/PreferenceBundles" target="_blank" rel="noopener">http://iphonedevwiki.net/index.php/PreferenceBundles</a></li><li><a href="https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html" target="_blank" rel="noopener">https://developer.apple.com/library/archive/documentation/General/Conceptual/ExtensibilityPG/ExtensionScenarios.html</a></li><li><a href="https://developer.apple.com/documentation/security/keychain_services" target="_blank" rel="noopener">https://developer.apple.com/documentation/security/keychain_services</a></li><li><a href="https://github.com/soffes/SAMKeychain" target="_blank" rel="noopener">https://github.com/soffes/SAMKeychain</a></li><li><a href="https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps" target="_blank" rel="noopener">https://developer.apple.com/documentation/security/keychain_services/keychain_items/sharing_access_to_keychain_items_among_a_collection_of_apps</a></li></ol></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Chen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://hechen.xyz/2018/12/21/UserDefaults-and-Keychain/">http://hechen.xyz/2018/12/21/UserDefaults-and-Keychain/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/UserDefaults-Keychain/">UserDefaults,Keychain</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=undefined" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/01/03/Swift-and-Modules/"><i class="fa fa-chevron-left"></i><span>在 Swift Framework 中使用 C 文件的过程探索</span></a></div><div class="next-post pull-right"><a href="/2018/11/26/Send-to-2Do/"><span>如何做 Send to 2Do 的书签</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused=null,disqus_config=function(){this.page.url="http://hechen.xyz/2018/12/21/UserDefaults-and-Keychain/",this.page.identifier="2018/12/21/UserDefaults-and-Keychain/",this.page.title="UserDefaults and Keychain"},d=document,s=d.createElement("script");s.src="https://stoneman.disqus.com/embed.js",s.setAttribute("data-timestamp",""+ +new Date),(d.head||d.body).appendChild(s)</script><script id="dsq-count-src" src="https://stoneman.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2019 By Chen</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script></body></html>