<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="关于 iOS10 Notification 的那些事儿"><meta name="keywords" content="iOS,Swift,Notification"><meta name="author" content="Chen,undefined"><meta name="copyright" content="Chen"><title>关于 iOS10 Notification 的那些事儿 | Writing, Thinking and Coding.</title><link rel="shortcut icon" href="/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?b8b088e1ebab51ca1f8e3c11ac0476a1";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>var GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:void 0,copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"}}</script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#概览"><span class="toc-number">1.</span> <span class="toc-text">概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#历史"><span class="toc-number">2.</span> <span class="toc-text">历史</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#变化"><span class="toc-number">3.</span> <span class="toc-text">变化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#权限申请"><span class="toc-number">3.1.</span> <span class="toc-text">权限申请</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#远程推送"><span class="toc-number">3.2.</span> <span class="toc-text">远程推送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Payloads"><span class="toc-number">3.3.</span> <span class="toc-text">Payloads</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#可以撤销和更新通知了！"><span class="toc-number">3.4.</span> <span class="toc-text">可以撤销和更新通知了！</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Notification-Extension"><span class="toc-number">3.5.</span> <span class="toc-text">Notification Extension</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#支持多媒体资源在通知中心的展示"><span class="toc-number">3.6.</span> <span class="toc-text">支持多媒体资源在通知中心的展示</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#推送证书的配置"><span class="toc-number">3.7.</span> <span class="toc-text">推送证书的配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Demo-演示-Knuff"><span class="toc-number">3.8.</span> <span class="toc-text">Demo 演示 Knuff</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://en.gravatar.com/userimage/112198960/798360714fd6208c863662c667290d7d.jpg?size=200"></div><div class="author-info__name text-center">Chen</div><div class="author-info__description text-center">I do stuff.</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">38</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">47</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">14</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container" style="background-image:url(true)"><div id="page-header"><span class="pull-left"><a id="site-name" href="/">Writing, Thinking and Coding.</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">关于 iOS10 Notification 的那些事儿</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-02</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/iOS/">iOS</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2017/05/20/iOS-Notification/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2017/05/20/iOS-Notification/"></span></a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">2,561</span><span class="post-meta__separator">|</span><span>Reading time: 10 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h3 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h3><p>推送通知我们大家都不陌生，可以说几乎每个使用智能手机的人每天都会被不同的通知 <em>打扰</em> 到，正式因为合适的推送是吸引用户注意力的利器，其成为了各 App 吸引用户，将用户带回到 App 本身，提升用户的活跃度的一种必要的方式。当然要注意的是，推送本身是一件对用户影响特别大的事情，毕竟注意力被打断，因此合适的推送时机也是各个 App 开发者所要注意的，否则就会成为用户勿扰名单里的一员了。</p><p>之前刚开始学习 iOS 开发的时候还整理了下当时部署 iOS 远程推送的流程，详见：<a href="http://hechen.info/2015/07/30/iOS-Push-Notification/" target="_blank" rel="noopener">iOS 远端推送部署详解</a></p><p>接下来，我们大致回顾一下 iOS 平台关于推送都有哪些历程？</p><a id="more"></a><h3 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h3><ul><li><p>&lt;= iOS 6</p><ul><li>远程推送通知 （iOS 3）</li><li>本地通知 （iOS 4）</li></ul></li><li><p>iOS 7 参考</p><ul><li>引入 Silent Remote Notifications</li></ul></li><li><p>iOS 8 参考 <a href="https://developer.apple.com/videos/play/wwdc2014/713/" target="_blank" rel="noopener">WWDC 2014 Session 713</a></p><ul><li>引入 Actionable Notifications</li><li>修改 Notification 的权限请求</li></ul></li><li><p>iOS 9 参考 <a href="https://developer.apple.com/videos/play/wwdc2015/720/" target="_blank" rel="noopener">WWDC 2015 Session 720</a></p><ul><li>引入 Text Input Action</li><li>UIUserNotificationActionBehavior</li></ul></li><li><p>iOS 10 参考 <a href="https://developer.apple.com/videos/play/wwdc2016/707" target="_blank" rel="noopener">WWDC 707 Introduction to Notifications</a> &amp;&amp; <a href="https://developer.apple.com/videos/play/wwdc2016/708" target="_blank" rel="noopener">WWDC 708 Advanced Notifications</a></p><ul><li>UserNotification Framework</li><li>Extensions</li></ul></li></ul><p>WWDC 2016 大会上，Apple 在 iOS 10 上引入了 <strong>UserNotification</strong> 框架，可以说是对之前的各种代码做了一次重构。该框架统一了通知的行为，尤其是针对远程推送和本地推送不再有两套完全不同的使用方式了。</p><h3 id="变化"><a href="#变化" class="headerlink" title="变化"></a>变化</h3><p>关于 iOS 10 上 UserNotification 框架的变化，主要从几个方面来讲述：</p><ol><li>权限申请</li><li>推送内容变更</li><li>推送管理</li><li>Extensions</li></ol><h4 id="权限申请"><a href="#权限申请" class="headerlink" title="权限申请"></a>权限申请</h4><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="type">UNUserNotificationCenter</span>.current().requestAuthorization(options: [.alert, .sound, .badge]) &#123;</span><br><span class="line">    granted, error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> granted &#123;</span><br><span class="line">        <span class="comment">// 用户允许进行通知</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="远程推送"><a href="#远程推送" class="headerlink" title="远程推送"></a>远程推送</h4><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 向 APNs 请求 token：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// iOS 10 support</span></span><br><span class="line"><span class="keyword">if</span> #available(iOS <span class="number">10</span>, *) &#123;  </span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().requestAuthorization(options:[.badge, .alert, .sound])&#123; (granted, error) <span class="keyword">in</span> &#125;</span><br><span class="line">    application.registerForRemoteNotifications()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// iOS 9 support</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> #available(iOS <span class="number">9</span>, *) &#123;  </span><br><span class="line"></span><br><span class="line"><span class="type">UIApplication</span>.shared.registerUserNotificationSettings(<span class="type">UIUserNotificationSettings</span>(types: [.badge, .sound, .alert], categories: <span class="literal">nil</span>))</span><br><span class="line">    <span class="type">UIApplication</span>.shared.registerForRemoteNotifications()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>关于注册远程通知的回调方法一致，</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// AppDelegate.swift</span></span><br><span class="line"> <span class="function"><span class="keyword">func</span> <span class="title">application</span><span class="params">(<span class="number">_</span> application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data)</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> tokenString = deviceToken.hexString</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Get Push token: <span class="subst">\(tokenString)</span>"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Payloads"><a href="#Payloads" class="headerlink" title="Payloads"></a>Payloads</h4><p>&lt; iOS 10</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aps"</span>:&#123;</span><br><span class="line">    <span class="attr">"alert"</span>:<span class="string">"Test"</span>,</span><br><span class="line">    <span class="attr">"sound"</span>:<span class="string">"default"</span>,</span><br><span class="line">    <span class="attr">"badge"</span>:<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>iOS 10 系统提供了更为丰富的结构，比如可以指定 Title，Subtitle 等</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="attr">"aps"</span>:&#123;</span><br><span class="line">     <span class="attr">"alert"</span>:&#123;</span><br><span class="line">       <span class="attr">"title"</span>:<span class="string">"This is a title"</span>,</span><br><span class="line">       <span class="attr">"subtitle"</span>:<span class="string">"This is a subtitle"</span>,</span><br><span class="line">       <span class="attr">"body"</span>:<span class="string">"This is body"</span></span><br><span class="line">     &#125;,</span><br><span class="line">     <span class="attr">"sound"</span>:<span class="string">"default"</span>,</span><br><span class="line">     <span class="attr">"badge"</span>:<span class="number">1</span></span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>甚至，现在可以支持多媒体的展示了，在 payload 上也有相应的体现，例如下面几例：</p><ol><li><p>支持图片</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"aps"</span>:&#123;</span><br><span class="line">        <span class="attr">"alert"</span>: &#123;</span><br><span class="line">            <span class="attr">"title"</span>: <span class="string">"Title: Notification Demo"</span>, </span><br><span class="line">            <span class="attr">"subtitle"</span>: <span class="string">"Subtitle: show iOS 10 support!"</span>,</span><br><span class="line">            <span class="attr">"body"</span>: <span class="string">"The Main Body For Notification!"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">"mutable-content"</span>: <span class="number">1</span></span><br><span class="line">        &#125;,</span><br><span class="line">    <span class="attr">"image"</span> : <span class="string">"https://pic1.zhimg.com/v2-0314056e4f13141b6ca2277078ec067c.jpg"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>支持音频</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"aps"</span>:&#123;</span><br><span class="line">        <span class="attr">"alert"</span>: &#123;</span><br><span class="line">        <span class="attr">"title"</span>: <span class="string">"Title: Notification Demo"</span>, </span><br><span class="line">        <span class="attr">"subtitle"</span>: <span class="string">"Subtitle: show iOS 10 support!"</span>, </span><br><span class="line">        <span class="attr">"body"</span>: <span class="string">"The Main Body For Notification!"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"mutable-content"</span>: <span class="number">1</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"audio"</span> : <span class="string">"http://hao.1015600.com/upload/ring/000/982/d9924a7f4e4ab06e52a11dfdd32ffae1.mp3"</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><p>具体所有的 Key 可以参考官方文档 <a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/PayloadKeyReference.html" target="_blank" rel="noopener">Payload Key Reference</a></p><blockquote><p>注意到有个 key: launch-image ，可以指定用户点击通知启动 App 的时候的 Launch Image</p></blockquote><h4 id="可以撤销和更新通知了！"><a href="#可以撤销和更新通知了！" class="headerlink" title="可以撤销和更新通知了！"></a>可以撤销和更新通知了！</h4><p>UserNotification 框架 API 提供了通知的更新和撤销的接口。具体功能主要包含几个部分：</p><ol><li><p>删除未展示的通知</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> trigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">3</span>, repeats: <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">let</span> identifier = <span class="type">Constants</span>.pendingRemoveNotificationIdentifier</span><br><span class="line"><span class="keyword">let</span> request = <span class="type">UNNotificationRequest</span>(identifier: identifier, content: title1Content, trigger: trigger)</span><br><span class="line"></span><br><span class="line"><span class="type">UNUserNotificationCenter</span>.current().add(request) &#123; error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"remove pending notification error: <span class="subst">\(error)</span>"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Notification request added: <span class="subst">\(identifier)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">delay(<span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Notification request removed: <span class="subst">\(identifier)</span>"</span>)</span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().removePendingNotificationRequests(withIdentifiers: [identifier])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>更新未展示的通知</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> trigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">3</span>, repeats: <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">let</span> identifier = <span class="type">Constants</span>.pendingUpdateNotificationIdentifier</span><br><span class="line"><span class="keyword">let</span> request = <span class="type">UNNotificationRequest</span>(identifier: identifier, content: title1Content, trigger: trigger)</span><br><span class="line"></span><br><span class="line"><span class="type">UNUserNotificationCenter</span>.current().add(request) &#123; error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"update pending notification error: <span class="subst">\(error)</span>"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Notification request added: <span class="subst">\(identifier)</span> with title1"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">delay(<span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> newTrigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">1</span>, repeats: <span class="literal">false</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add new request with the same identifier to update a notification.</span></span><br><span class="line">    <span class="keyword">let</span> newRequest = <span class="type">UNNotificationRequest</span>(identifier: identifier, content: <span class="keyword">self</span>.title2Content, trigger: newTrigger)</span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().add(newRequest) &#123; error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"update delivered notification error: <span class="subst">\(error)</span>"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Notification request updated: <span class="subst">\(identifier)</span> with title2"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>删除已经展示的通知</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> trigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">3</span>, repeats: <span class="literal">false</span>)</span><br><span class="line"><span class="keyword">let</span> identifier = <span class="type">Constants</span>.pendingUpdateNotificationIdentifier</span><br><span class="line"><span class="keyword">let</span> request = <span class="type">UNNotificationRequest</span>(identifier: identifier, content: title1Content, trigger: trigger)</span><br><span class="line"></span><br><span class="line"><span class="type">UNUserNotificationCenter</span>.current().add(request) &#123; error <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"update pending notification error: <span class="subst">\(error)</span>"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Notification request added: <span class="subst">\(identifier)</span> with title1"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">delay(<span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> newTrigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">1</span>, repeats: <span class="literal">false</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Add new request with the same identifier to update a notification.</span></span><br><span class="line">    <span class="keyword">let</span> newRequest = <span class="type">UNNotificationRequest</span>(identifier: identifier, content: <span class="keyword">self</span>.title2Content, trigger: newTrigger)</span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().add(newRequest) &#123; error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"update delivered notification error: <span class="subst">\(error)</span>"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Notification request updated: <span class="subst">\(identifier)</span> with title2"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>更新已经展示的通知</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> trigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">3</span>, repeats: <span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">let</span> identifier = <span class="type">Constants</span>.deliveredUpdateNotificationIdentifier</span><br><span class="line">    <span class="keyword">let</span> request = <span class="type">UNNotificationRequest</span>(identifier: identifier, content: title1Content, trigger: trigger)</span><br><span class="line">    </span><br><span class="line">    <span class="type">UNUserNotificationCenter</span>.current().add(request) &#123; error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Notification request added: <span class="subst">\(identifier)</span> with title1"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    delay(<span class="number">4</span>) &#123;</span><br><span class="line">        <span class="keyword">let</span> newTrigger = <span class="type">UNTimeIntervalNotificationTrigger</span>(timeInterval: <span class="number">1</span>, repeats: <span class="literal">false</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Add new request with the same identifier to update a notification.</span></span><br><span class="line">        <span class="keyword">let</span> newRequest = <span class="type">UNNotificationRequest</span>(identifier: identifier, content: <span class="keyword">self</span>.title2Content, trigger: newTrigger)</span><br><span class="line">        <span class="type">UNUserNotificationCenter</span>.current().add(newRequest) &#123; error <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">                </span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">"Notification request updated: <span class="subst">\(identifier)</span> with title2"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></li></ol><p>当然，上述均是针对本地通知的操作，关于远程推送通知，目前只支持更新通知，远程推送可以进行通知的更新，在使用 Provider API 向 APNs 提交请求时，在 HTTP/2 的 header 中 apns-collapse-id key 的内容将被作为该推送的标识符进行使用。多次推送同一标识符的通知即可进行更新。</p><h4 id="Notification-Extension"><a href="#Notification-Extension" class="headerlink" title="Notification Extension"></a>Notification Extension</h4><p>iOS 10 中最重要的一个变化就是 Extension，从 iMessage Extension 到 SiriKit 中提供的 Intent Extension 等，那对于 UserNotification 来讲就是下面这两种 Extension：</p><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/18D62919-DA73-4D3D-9B05-6071E6945764-1.png" alt="18D62919-DA73-4D3D-9B05-6071E6945764"></p><ol><li>Service Extension</li></ol><p>具体而言，就是我们可以在收到通知之后，在展示给用户之前 ，也就是以Banner 或者 Alert 的形式 或者 进入通知中心之前，给我们一次截取并处理的机会，这样就给开发者提供了针对推送通知再加工的手段，并且远程推送多媒体也是通过 Service Extension 来实现的。</p><blockquote><p>使用在本机截取推送并替换内容的方式，可以完成端到端 (end-to-end) 的推送加密。你在服务器推送 payload 中加入加密过的文本，在客户端接到通知后使用预先定义或者获取过的密钥进行解密之后再显示。这样一来，即使推送信道被第三方截取，其中所传递的内容也还是安全的。使用这种方式来发送密码或者敏感信息，对于一些金融业务应用和聊天应用来说，应该是必备的特性。</p></blockquote><p>生成 Extension 之后，系统已经为我们提供了模板，代码如下：</p><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotificationService</span>: <span class="title">UNNotificationServiceExtension</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> contentHandler: ((<span class="type">UNNotificationContent</span>) -&gt; <span class="type">Void</span>)?</span><br><span class="line">    <span class="keyword">var</span> bestAttemptContent: <span class="type">UNMutableNotificationContent</span>?</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceive</span><span class="params">(<span class="number">_</span> request: UNNotificationRequest, withContentHandler contentHandler: @escaping <span class="params">(UNNotificationContent)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.contentHandler = contentHandler</span><br><span class="line">        bestAttemptContent = (request.content.mutableCopy() <span class="keyword">as</span>? <span class="type">UNMutableNotificationContent</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> bestAttemptContent = bestAttemptContent &#123;</span><br><span class="line">            contentHandler(bestAttemptContent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">serviceExtensionTimeWillExpire</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// Called just before the extension will be terminated by the system.</span></span><br><span class="line">        <span class="comment">// Use this as an opportunity to deliver your "best attempt" at modified content, otherwise the original push payload will be used.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> contentHandler = contentHandler, <span class="keyword">let</span> bestAttemptContent =  bestAttemptContent &#123;</span><br><span class="line">            contentHandler(bestAttemptContent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>Content Extension<br>iOS 10 SDK 新加的另一个 Content Extension 可以用来自定义通知的详细页面的视图。 下图中就是几款市面上目前已经实现过自定义 Content Extension 的 App 截图。需要注意的是：</li></ol><p>第一个 PriceTag App 的通知样式，实际上是默认的系统显示行为。</p><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/IMG_AD4882D0ECDE-1.jpeg" alt="IMG_AD4882D0ECDE-1"></p><p>其中需要注意的一点是。如果不想默认显示通知内容，需要在 Content Extension 的 info.plist 文件中添加 UNNotificationExtensionDefaultContentHidden 并设置为 YES</p><h4 id="支持多媒体资源在通知中心的展示"><a href="#支持多媒体资源在通知中心的展示" class="headerlink" title="支持多媒体资源在通知中心的展示"></a>支持多媒体资源在通知中心的展示</h4><p>iOS 10 中另一个比较显著的特点就是支持了多媒体的推送和展示。开发者现在可以在通知中嵌入图片、音频甚至视频，这极大丰富了推送内容的可读性和趣味性。</p><ol><li>本地推送支持<br>本地通知添加多媒体比较简单一些，只需要通过本地磁盘上的文件 URL 创建一个 UNNotificationAttachment 对象，然后将这个对象放到数组中赋值给 content 的 attachments 属性就行了：</li></ol><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> content = <span class="type">UNMutableNotificationContent</span>()</span><br><span class="line">content.title = <span class="string">"Image Notification"</span></span><br><span class="line">content.body = <span class="string">"Show me an image!"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">let</span> imageURL = <span class="type">Bundle</span>.main.url(forResource: <span class="string">"image"</span>, withExtension: <span class="string">"jpg"</span>),</span><br><span class="line">   <span class="keyword">let</span> attachment = <span class="keyword">try</span>? <span class="type">UNNotificationAttachment</span>(identifier: <span class="string">"imageAttachment"</span>, url: imageURL, options: <span class="literal">nil</span>) &#123;</span><br><span class="line">    content.attachments = [attachment]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>远程推送支持</li></ol><p>首先需要在 payloads 结构中添加对富媒体的支持，aps 字典中添加字段<code>mutable-content</code>并置为 1 来标识该远程通知是需要支持。 然后可以在 payloads 中添加资源地址，可以是本地的资源，也可以是需要 App 下载的。</p><figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"aps"</span>:&#123;</span><br><span class="line">    <span class="attr">"alert"</span>:&#123;</span><br><span class="line">      <span class="attr">"title"</span>:<span class="string">"Image Notification"</span>,</span><br><span class="line">      <span class="attr">"body"</span>:<span class="string">"Show me an image from web!"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"mutable-content"</span>:<span class="number">1</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"zh_image"</span>: <span class="string">"https://pic1.zhimg.com/v2-0314056e4f13141b6ca2277078ec067c.jpg"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>具体支持多媒体文件的富媒体类型以及每一种类型所支持的大小详官方文档 <a href="https://developer.apple.com/reference/usernotifications/unnotificationattachment" target="_blank" rel="noopener">UNNotificationAttachment</a></p><p>一旦远程推送在 aps 中添加 mutable-content 的key 并设置为 1 之后，iOS 系统接收到该推送之后就会唤起我们配套的 Service Extension 来做进一步处理，我们可以在其中下载对应 zh_image 链接的图片，然后生成 Attachment 再丢给系统处理即可。 详细做法就是在上一节讲 Service Extension 中的 <code>didReceive</code> 中写相应逻辑即可，具体代码如下所示：</p><p>当然，这里的处理时间是存在时间限制的，如果处理超时系统就会回收该 Extension，并且调用 <code>serviceExtensionTimeWillExpire</code> 方法，因此每个人收到带有附件的推送之后不一定展示相同，例如下图所示的情况，第一张和第二张就属于正常设置了附件的情况，而第三张就是没有在有限时间内正确设置附件的情况。</p><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/14953507334611.png" alt="未成功设置附件的情况"></p><h4 id="推送证书的配置"><a href="#推送证书的配置" class="headerlink" title="推送证书的配置"></a>推送证书的配置</h4><p>下图是获取推送通知证书并将其注册到 Leancloud 的流程，最关键的地方其实就是需要在本机生成 CSR 文件提交到 Apple Developer Website 生成 Push Certification 文件。</p><p>主要有几个步骤：</p><ol><li>AppID 关于 Remote Push 的 注册</li><li>生成推送证书</li><li>转换证书为 P12 文件，并提供给 Leancloud</li></ol><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/02.png" alt="02"></p><p>XCode 8 的 Auto Signing 已经省去了难以名状的复杂，但是还是有一点小事情我们需要做。</p><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/iOS App IDs - Apple Developer Google Chrome, 今天 at 下午5.01.22.png" alt="iOS App IDs - Apple Developer Google Chrome, 今天 at 下午5.01.22"></p><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/0CB09A98-0D9B-4E76-BA7C-9A1766CFEC42.png" alt="0CB09A98-0D9B-4E76-BA7C-9A1766CFE"></p><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/Add - iOS Certificates - Apple Developer Google Chrome, 今天 at 下午5.07.47.png" alt="Add - iOS Certificates - Apple Developer Google Chrome, 今天 at 下午5.07.47"></p><p>我们需要生成 CSR 文件 ，按照指定步骤按部就班来就行，最后会生成 默认文件 <em>CertificateSigningRequest.certSigningRequest</em></p><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/Finder Finder, 今天 at 下午4.59.55.png" alt="Finder Finder, 今天 at 下午4.59.55"><br><img src="http://7xilk1.com1.z0.glb.clouddn.com/证书助理 证书助理, 今天 at 下午5.05.42.png" alt="证书助理 证书助理, 今天 at 下午5.05.42"></p><p>接着之前的步骤，选择 CSR 文件上传。</p><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/Add - iOS Certificates - Apple Developer Google Chrome, 今天 at 下午5.09.07.png" alt="Add - iOS Certificates - Apple Developer Google Chrome, 今天 at 下午5.09.07"></p><p>上传成功之后就会生成 Push 证书，下载到本机安装上。</p><p><img src="http://7xilk1.com1.z0.glb.clouddn.com/Add - iOS Certificates - Apple Developer Google Chrome, 今天 at 下午5.09.58.png" alt="Add - iOS Certificates - Apple Developer Google Chrome, 今天 at 下午5.09.58"></p><h4 id="Demo-演示-Knuff"><a href="#Demo-演示-Knuff" class="headerlink" title="Demo 演示  Knuff"></a>Demo 演示 <a href="https://github.com/KnuffApp/Knuff" target="_blank" rel="noopener">Knuff</a></h4><p>参考资料</p><ol><li><a href="https://developer.apple.com/library/content/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/index.html#//apple_ref/doc/uid/TP40008194-CH3-SW1" target="_blank" rel="noopener">Local and Remote Notification Programming Guide</a></li><li><a href="https://developer.apple.com/reference/usernotifications" target="_blank" rel="noopener">UserNotifications 官方文档</a></li><li><a href="http://wereadteam.github.io/2017/03/13/Signature/" target="_blank" rel="noopener">iOS App 签名的原理</a></li><li><a href="https://medium.com/@scomper/探究-iphone-的后台刷新-a7a96cb426d4" target="_blank" rel="noopener">iPhone 的后台刷新</a></li></ol></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Chen</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://hechen.xyz/2017/05/20/iOS-Notification/">http://hechen.xyz/2017/05/20/iOS-Notification/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/iOS/">iOS</a><a class="post-meta__tags" href="/tags/Swift/">Swift</a><a class="post-meta__tags" href="/tags/Notification/">Notification</a></div><div class="addthis_inline_share_toolbox pull-right"></div><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=undefined" async></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2017/10/17/Thread-Programming-Guide/"><i class="fa fa-chevron-left"></i><span>阅读 《Thread Programming Guide》</span></a></div><div class="next-post pull-right"><a href="/2017/02/12/Reading-Garbage-Collection/"><span>阅读《垃圾回收的算法与实现》</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused=null,disqus_config=function(){this.page.url="http://hechen.xyz/2017/05/20/iOS-Notification/",this.page.identifier="2017/05/20/iOS-Notification/",this.page.title="关于 iOS10 Notification 的那些事儿"},d=document,s=d.createElement("script");s.src="https://stoneman.disqus.com/embed.js",s.setAttribute("data-timestamp",""+ +new Date),(d.head||d.body).appendChild(s)</script><script id="dsq-count-src" src="https://stoneman.disqus.com/count.js" async></script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2019 By Chen</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script></body></html>